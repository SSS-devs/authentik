# Generated by Django 5.1.10 on 2025-06-10 14:17

import pgtrigger.compiler
import pgtrigger.migrations
from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("authentik_tasks", "0001_initial"),
    ]

    operations = [
        pgtrigger.migrations.AddTrigger(
            model_name="task",
            trigger=pgtrigger.compiler.Trigger(
                name="update_aggregated_status",
                sql=pgtrigger.compiler.UpsertTriggerSql(
                    constraint="CONSTRAINT",
                    declare="DECLARE aggregated_status TEXT; max_log_level TEXT;",
                    func="\n                    NEW.aggregated_status := CASE\n                        WHEN NEW.status != 'done' THEN NEW.status\n                        ELSE COALESCE((\n                            SELECT CASE\n                                WHEN bool_or(msg->'log_level' = 'error') THEN 'error'\n                                WHEN bool_or(msg->'log_level' = 'warning') THEN 'warning'\n                                WHEN bool_or(msg->'log_level' = 'info') THEN 'info'\n                                ELSE 'done'\n                            END\n                            FROM jsonb_array_elements(NEW._messages) AS msg\n                        ), 'done')\n                    END;\n\n                    RETURN NEW;\n                ",
                    hash="9f97b7e85dd6428402da79d4f748740f0a3ac88c",
                    operation="INSERT OR UPDATE",
                    pgid="pgtrigger_update_aggregated_status_f18c4",
                    table="authentik_tasks_task",
                    timing="DEFERRABLE INITIALLY IMMEDIATE",
                    when="AFTER",
                ),
            ),
        ),
    ]
